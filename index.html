<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>千端网盘</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 400px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 10px;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            border: none;
        }
        .register-btn {
            background-color: #4CAF50;
            color: white;
        }
        .login-btn {
            background-color: #2196F3;
            color: white;
        }
        .welcome {
            color: #333;
            margin-bottom: 20px;
        }
        .logout-btn {
            background-color: #f44336;
            color: white;
        }
        .upload-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .file-input {
            margin: 10px 0;
        }
        .upload-btn {
            background-color: #FF9800;
            color: white;
        }
        .github-auth-btn {
            background-color: #333;
            color: white;
        }
        .file-list {
            text-align: left;
            margin-top: 20px;
        }
        .file-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .upload-progress {
            margin-top: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>千端网盘</h1>
        <div id="authSection">
            <a href="register.html" class="btn register-btn">注册</a>
            <a href="login.html" class="btn login-btn">登录</a>
        </div>
        <div id="userSection" style="display: none;">
            <p class="welcome">欢迎，<span id="username"></span>！</p>
            
            <!-- GitHub 认证区域 -->

            <div class="upload-section">

                <h3>GitHub 认证</h3>

                <p>为了保存内容，需要连接到您的 GitHub 账户</p>

                <button id="githubAuthBtn" class="btn github-auth-btn">连接 GitHub</button>

                <div id="githubStatus"></div>

            </div>

            

            <!-- 创建 Gist 区域 -->

            <div class="upload-section">

                <h3>创建新 Gist</h3>

                <input type="text" id="gistFilename" class="file-input" placeholder="文件名 (如: my-note.txt)">

                <textarea id="gistContent" class="file-input" rows="5" placeholder="在这里输入内容..."></textarea>

                <button id="createGistBtn" class="btn upload-btn" disabled>创建 Gist</button>

                <div id="gistStatus"></div>

            </div>

            

            <!-- Gist 列表 -->

            <div class="file-list">

                <h3>我的 Gists</h3>

                <div id="gistList"></div>

            </div>
            
            <a href="#" class="btn logout-btn" id="logoutBtn">退出登录</a>
        </div>
    </div>
    <script>
        // GitHub 配置

        const GITHUB_TOKEN_KEY = 'github_token';

        const GIST_LIST_KEY = 'user_gists';
        
        // 检查用户登录状态
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (isLoggedIn && currentUser) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('userSection').style.display = 'block';
                document.getElementById('username').textContent = currentUser.username;
                // 检查 GitHub 认证状态
                checkGithubAuth();
                // 加载用户文件列表
                loadUserFiles();
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('userSection').style.display = 'none';
            }
        }
        
        // 检查 GitHub 认证状态

        function checkGithubAuth() {

            const token = getGithubToken(); // 使用解密函数获取token

            const githubStatus = document.getElementById('githubStatus');

            const createGistBtn = document.getElementById('createGistBtn');

            

            if (token) {

                githubStatus.textContent = '已连接到 GitHub';

                githubStatus.style.color = 'green';

                createGistBtn.disabled = false;

            } else {

                githubStatus.textContent = '请连接 GitHub 以启用 Gist 功能';

                githubStatus.style.color = 'red';

                createGistBtn.disabled = true;

            }

        }
        
        // GitHub 认证

        document.getElementById('githubAuthBtn').addEventListener('click', function() {

            // GitHub OAuth 配置

            const CLIENT_ID = 'Ov23liRWx0TWNCcNMYSx'; // 需要替换为实际的Client ID

            const REDIRECT_URI = encodeURIComponent(window.location.href.split('?')[0]);

            const SCOPE = 'gist'; // 只请求gist权限

            

            // 构建OAuth URL

            const authUrl = `https://github.com/login/oauth/authorize?` +

                `client_id=${CLIENT_ID}&` +

                `redirect_uri=${REDIRECT_URI}&` +

                `scope=${SCOPE}&` +

                `state=${Math.random().toString(36).substring(2, 15)}`;

            

            // 重定向到GitHub OAuth页面

            window.location.href = authUrl;

        });

        

        // 处理OAuth回调

        function handleOAuthCallback() {

            const urlParams = new URLSearchParams(window.location.search);

            const code = urlParams.get('code');

            const state = urlParams.get('state');

            

            if (code) {

                // 在真实的部署环境中，这里会通过后端服务器安全地获取access_token。

                // 由于这是GitHub Pages静态页面，无法直接获取token，需要通过后端服务处理。

                // 作为替代方案，我们可以引导用户在GitHub上复制token并手动输入

                alert('认证成功！现在请在GitHub授权页面复制access_token，并在弹出的对话框中输入。');

                

                // 清理URL参数

                window.history.replaceState({}, document.title, window.location.pathname);

                

                // 提示用户输入token

                const token = prompt('请输入从GitHub获取的access_token:');

                if (token) {

                    saveGithubToken(token); // 使用加密函数存储token

                    checkGithubAuth();

                }

            }

        }
        
        // 退出登录功能 - 只清除登录状态，保留注册信息

        document.getElementById('logoutBtn').addEventListener('click', function(e) {

            e.preventDefault();

            // 只清除登录状态，保留用户注册信息

            localStorage.removeItem('isLoggedIn');

            localStorage.removeItem('currentUser');

            // 同时清除 GitHub token

            localStorage.removeItem(GITHUB_TOKEN_KEY);

            checkLoginStatus();

        });
        
        // 创建 Gist 功能
        document.getElementById('createGistBtn').addEventListener('click', function() {
            const filename = document.getElementById('gistFilename').value;
            const content = document.getElementById('gistContent').value;
            
            if (!filename) {
                alert('请输入文件名');
                return;
            }
            
            if (!content) {
                alert('请输入内容');
                return;
            }
            
            const token = getGithubToken(); // 使用解密函数获取token
            if (!token) {
                alert('请先连接 GitHub');
                return;
            }
            
            // 创建 Gist
            createGist(filename, content, token);
        });
        
        // 创建 Gist
        async function createGist(filename, content, token) {
            const gistStatus = document.getElementById('gistStatus');
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: '通过千端网盘创建',
                        public: false, // 设为 false 以创建私有 Gist
                        files: {
                            [filename]: {
                                content: content
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '创建失败');
                }
                
                const result = await response.json();
                
                gistStatus.textContent = 'Gist 创建成功！';
                gistStatus.style.color = 'green';
                
                // 清空表单
                document.getElementById('gistFilename').value = '';
                document.getElementById('gistContent').value = '';
                
                // 重新加载 Gist 列表
                loadUserGists();
            } catch (error) {
                gistStatus.textContent = `创建失败: ${error.message}`;
                gistStatus.style.color = 'red';
                console.error('创建 Gist 错误:', error);
            }
        }
        
        // 加载用户 Gist 列表
        async function loadUserGists() {
            const token = getGithubToken(); // 使用解密函数获取token
            
            if (!token) {
                // 如果没有 token，显示本地缓存的 Gist 列表
                displayLocalGists();
                return;
            }
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取 Gist 列表失败');
                }
                
                const gists = await response.json();
                
                // 只显示包含通过千端网盘创建的 Gist
                const filteredGists = gists.filter(gist => 
                    gist.description && gist.description.includes('通过千端网盘创建')
                );
                
                // 显示 Gist 列表
                displayGists(filteredGists);
                
                // 同时保存到本地存储
                localStorage.setItem(GIST_LIST_KEY, JSON.stringify(filteredGists));
            } catch (error) {
                console.error('加载 Gist 列表错误:', error);
                // 如果 API 加载失败，显示本地缓存的 Gist 列表
                displayLocalGists();
            }
        }
        
        // 显示 Gist 列表
        function displayGists(gists) {
            const gistList = document.getElementById('gistList');
            
            if (gists.length === 0) {
                gistList.innerHTML = '<p>暂无 Gist</p>';
                return;
            }
            
            gistList.innerHTML = gists.map(gist => {
                // 获取文件名和内容
                const fileName = Object.keys(gist.files)[0];
                const file = gist.files[fileName];
                
                return `
                    <div class="file-item">
                        <div><strong>${fileName}</strong></div>
                        <div class="file-actions">
                            <button onclick="viewGist('${gist.id}', '${fileName}')">查看</button>
                            <button onclick="deleteGist('${gist.id}')">删除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 显示本地缓存的 Gist 列表
        function displayLocalGists() {
            const localGists = JSON.parse(localStorage.getItem(GIST_LIST_KEY) || '[]');
            displayGists(localGists);
        }
        
        // 查看 Gist
        async function viewGist(gistId, fileName) {
            const token = getGithubToken(); // 使用解密函数获取token
            
            if (!token) {
                alert('请先连接 GitHub');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取 Gist 内容失败');
                }
                
                const gist = await response.json();
                const content = gist.files[fileName].content;
                
                // 在弹窗中显示内容
                alert(`文件名: ${fileName}

内容:
${content}`);
            } catch (error) {
                alert('查看 Gist 失败: ' + error.message);
                console.error('查看 Gist 错误:', error);
            }
        }
        
        // 删除 Gist
        async function deleteGist(gistId) {
            const token = getGithubToken(); // 使用解密函数获取token
            
            if (!token) {
                alert('请先连接 GitHub');
                return;
            }
            
            if (!confirm('确定要删除这个 Gist 吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('删除失败');
                }
                
                alert('Gist 删除成功！');
                
                // 重新加载 Gist 列表
                loadUserGists();
            } catch (error) {
                alert('删除失败: ' + error.message);
                console.error('删除 Gist 错误:', error);
            }
        }
        
        // 页面加载时检查登录状态

        window.onload = function() {

            checkLoginStatus();

            handleOAuthCallback(); // 处理OAuth回调

        };
    </script>
</body>
</html>